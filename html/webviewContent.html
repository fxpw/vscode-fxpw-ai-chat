<!DOCTYPE html>
<html lang="en">
<head>
	<!-- <script src="https://cdn.jsdelivr.net/npm/highlight.js/lib/core.js"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js/styles/vs2015.min.css">
	<!-- Подключаем необходимые языки -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ini.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/sql.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/css.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/scss.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/shell.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/xml.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cmake.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/makefile.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/dockerfile.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/n1ql.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="css/body.css">
	<link rel="stylesheet" href="css/code.css">
	<link rel="stylesheet" href="css/copyButton.css">
	<link rel="stylesheet" href="css/h1.css">
	<link rel="stylesheet" href="css/queryInput.css">
	<link rel="stylesheet" href="css/response.css">
	<link rel="stylesheet" href="css/sendQueryButton.css">

</head>
<body>

	<h1>
		Send requst to OpenAI
	</h1>
	
	<textarea id="queryInput" class="queryInput" placeholder="Enter your request">
	</textarea>

	<button id="sendQueryButton" class="sendQueryButton">
		Send
	</button>

	<div id="response" class="response">
	</div>


	<script>
		let vscode = acquireVsCodeApi();
		let intervalid = 0;
		let sendQueryButton = document.getElementById('sendQueryButton');

		function intervalChangeSendQueryText(){
			sendQueryButton.textContent = 'Process...';
			sendQueryButton.disabled = true;
			let dots = 3;
			const updateButtonText = () => {
				let text = 'Process' + '.'.repeat(dots);
				sendQueryButton.textContent = text;
				dots = (dots + 1) % 4;
			};
			updateButtonText();
			intervalId = setInterval(updateButtonText, 900);
		}

		function sendQueryButtonOnClick(){
			intervalChangeSendQueryText();
			let query = document.getElementById('queryInput').value;
			vscode.postMessage({
				command: 'queryOpenAI',
				text: query
			});
		}

		sendQueryButton.addEventListener('click', () => {
			sendQueryButtonOnClick();
		});

		window.addEventListener('message', event => {
			let message = event.data;
			switch (message.command) {
				case 'response':
					let responseElement = document.getElementById('response');
					if(message.response.trim() !== '') { // Проверяем, не пуст ли ответ
						responseElement.innerHTML = marked.parse(message.response);
						const codeBlocks = responseElement.querySelectorAll('pre code');
						if (codeBlocks){
							codeBlocks.forEach((block) => {
								hljs.highlightElement(block);
								let copyButton = document.createElement('button');
								copyButton.textContent = 'copy';
								copyButton.className = 'copyButton';
								copyButton.type = 'button';
								copyButton.addEventListener('click', () => {
									navigator.clipboard.writeText(block.textContent).then(() => {
										btn.textContent = 'done!';
										setTimeout(() => copyButton.textContent = 'copy', 2000);
									}).catch(err => console.error('html/webviewContent.html error: ', err));
								});
								block.parentNode.insertBefore(copyButton, block);
							});
						}
						responseElement.style.display = 'block';
					} else {
						responseElement.style.display = 'none';
					}
					const sendButton = document.getElementById('sendQuery');
					sendButton.textContent = 'Send';
					sendButton.disabled = false;
					clearInterval(intervalId);
					break;
			}
		});
		
		let queryInput = document.getElementById('queryInput');
		queryInput.addEventListener('input', function() {
			this.style.height = 'auto';
			this.style.height = (this.scrollHeight) + 'px';
		});

		queryInput.addEventListener('keydown', function(event) {
			const sendButton = document.getElementById('sendQuery');
			if (event.key === 'Enter' && !event.shiftKey && sendButton && !sendButton.disabled) {
				event.preventDefault();
				sendQueryButtonOnClick();
			}
		});

		document.addEventListener('DOMContentLoaded', function() {
			document.getElementById('response').style.display = 'none';
			marked.setOptions({
				highlight: function(code, lang) {
					const language = hljs.getLanguage(lang) ? lang : 'plaintext';
					return hljs.highlight(code, { language }).value;
				}
			});
		});
	</script>
</body>
</html>